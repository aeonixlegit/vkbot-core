# Использование базы данных внутри бота

`Небольшое примечание: код, указанный ниже на момент чтения данного сообщения может быть неактуальным или частично неактуальным, однако документация полностью корректна.`

### Введение

Для использоавние базы данных внутри бота, необходимо совсем немного логики и знания по теме массивов.

### Начало

Для начала использования базы данных, внутрь функции обработки сообщения необходимо добавить получение переменной `db`, как это показано в примере ниже.

```js
function: async (msg, { db }) => { /* ... */ },
```

### Использование

Использовать базу данных очень просто, давайте разберем её на нескольких примерах.

Для примера была написана команда, которая будет выдавать права доступа внутри бота пользователю.

```js
module.exports = {
  tag: ['права'],
  function: async (msg, { db }) => {
    if (!msg.hasForwards) return msg.error('Перешлите сообщение того, кому хотите выдать права')

    const vkid = msg.forwards[0].from_id
    const right = msg.text.split(' ')[1]
    if (!rights) return msg.error('Укажите какое право выдать')

    let user = await db.getUser(vkid)
    user.right = right
    db.write()

    msg.ok(`Пользователю [id${user.id}|${user.nick}] успешно выдано ${right} право`)
  },
  rights: 3,
  help: 'права [номер]',
  desc: 'выдать права пользователю'
 ```

Давайте по порядку разберем все выше написанное.

<hr />

```js
function: async (msg, { db }) => { /* ... */ }
```

Была создана асинхронная функция для работы с `await`, а внутрь неё было добавлено получение переменных об сообщении и базы данных.

<hr />

```js
if (!msg.hasForwards) return msg.error('Перешлите сообщение того, кому хотите выдать права')
```

Была произведена проверка на наличие пересланных сообщений, если таковых не имеется, то производится отправка сообщения об ошибке.

<hr />

```js
const vkid = msg.fwds[0].from_id
const right = msg.text.split(' ')[1]
if (!rights) return msg.error('Укажите какое право выдать')
```

Были созданы две постоянные переменные, которые содержат ID *жертвы* и право, которое необходимо ей выдать соответственно.

После этого была произведена проверка на наличие аргументов у команды, если таковых не имеется, то производится отправка сообщения об ошибке.

<hr />

```js
let user = await db.getUser(vkid)
user.right = right
db.write()
```

Самое интересное, работа с базой данных.

Была создана внутренняя переменная `user`, содержащая информацию о жертве, с помощью встроенной в `start.js` функции `getUser()`.

После чего, в локальном контекте пользователю было присвоено право из аргументов.

После присвоения прав было произведено обновление базы данных.

<hr />

```js
msg.ok(`Пользователю [id${user.id}|${user.nick}] успешно выдано ${right} право`)
```

Была произведена отправка сообщения об успехе.

## Полезная информация

Для более широкого использования базы данных вам следует знать как использовать саму базу.

Из примера выше вы узнали, что переменная `db` необходима для запросам к базе данных.

Давайте научимся делать подобные запросы.

<hr />

```js
db.get('users')
```

Получить всех пользователей без возможности посмотреть. Основа.

<hr />

```js
db.get('users').find({ id: айди }).value()
```

Получить одного пользователя прямо из базы данных. Где "айди", указывать вк айди того, кого хотите получить.

<hr />

```js
db.get('users').find().value()
```

Получить всех пользователей с возможностью просмотреть каждого.

<hr />

Чтобы "запихнуть" всех пользователей в одну переменную нужно просто её объявить. Вот так:

```js
let users = db.get('users').find().value()
```

И теперь вы может использовать эту переменную. Например отправить ник первого пользователя:

```js
msg.send(users[0].nick)
```

<hr />

```js
db.getUser(id)
```

Получение конкретного пользователя. Моя личная функция. Если при получении пользователь не найден, то он создастся в базе.
Эдака "авторегистрация". Использовать функцию нужно с `await`:

```js
let user = await db.getUser(1)
msg.send(user.nick)
```
